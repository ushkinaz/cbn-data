name: Pull Cataclysm-BN data

on:
  schedule:
    - cron: '40 */12 * * *'
  workflow_dispatch: {}

jobs:
  pull-data:
    name: Pull Cataclysm-BN data
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '24.x'
      - run: yarn --ignore-engines --frozen-lockfile
      - uses: actions/github-script@v8
        with:
          script: |
            const { default: run } = await import('${{ github.workspace }}/pull-data.mjs')

            await run({ github, context })
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Gather updated gfx targets
        id: gfx_targets
        run: |
          python3 - <<'PY'
          import json
          import os
          import subprocess

          msg = subprocess.check_output(
              ["git", "log", "-1", "--pretty=%s"], text=True
          ).strip()
          targets = []
          if msg.startswith("Update data for "):
              diff = subprocess.check_output(
                  ["git", "diff", "--name-only", "HEAD~1"], text=True
              ).splitlines()
              for path in diff:
                  parts = path.split("/")
                  if len(parts) >= 3 and parts[0] == "data" and parts[2] == "gfx":
                      target = "/".join(parts[:3])
                      if target not in targets:
                          targets.append(target)

          with open(os.environ["GITHUB_OUTPUT"], "a") as handle:
              handle.write(f"targets={json.dumps(targets)}\n")
          PY
      - name: Stage gfx WebP copies
        id: gfx_stage
        if: steps.gfx_targets.outputs.targets != '[]'
        env:
          GFX_TARGETS: ${{ steps.gfx_targets.outputs.targets }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import shutil

          targets = json.loads(os.environ["GFX_TARGETS"])
          repo_root = os.getcwd()
          stage_root = os.path.join(repo_root, ".gfx-webp-stage")
          if os.path.exists(stage_root):
              shutil.rmtree(stage_root)

          created = 0
          for target in targets:
              target_path = os.path.join(repo_root, target)
              if not os.path.isdir(target_path):
                  continue
              for dirpath, _, filenames in os.walk(target_path):
                  for name in filenames:
                      if not name.lower().endswith(".png"):
                          continue
                      src = os.path.join(dirpath, name)
                      rel = os.path.relpath(src, repo_root)
                      rel_webp = rel[:-4] + ".webp"
                      dest_repo = os.path.join(repo_root, rel_webp)
                      if os.path.exists(dest_repo):
                          continue
                      dest_stage = os.path.join(stage_root, rel_webp)
                      os.makedirs(os.path.dirname(dest_stage), exist_ok=True)
                      shutil.copyfile(src, dest_stage)
                      created += 1

          if created == 0 and os.path.exists(stage_root):
              shutil.rmtree(stage_root)

          with open(os.environ["GITHUB_OUTPUT"], "a") as handle:
              handle.write(f"created={created}\n")
          PY
      - name: Convert staged gfx to WebP
        if: steps.gfx_stage.outputs.created != '0'
        uses: calibreapp/image-actions@main
        with:
          compressOnly: true
          ignorePaths: '**/*.png,**/*.jpg,**/*.jpeg,**/*.avif'
          minPctChange: '-10000'
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}/.gfx-webp-stage
      - name: Sync gfx WebP into repo
        if: steps.gfx_stage.outputs.created != '0'
        run: |
          python3 - <<'PY'
          import os
          import shutil

          repo_root = os.getcwd()
          stage_root = os.path.join(repo_root, ".gfx-webp-stage")
          for dirpath, _, filenames in os.walk(stage_root):
              for name in filenames:
                  if not name.lower().endswith(".webp"):
                      continue
                  src = os.path.join(dirpath, name)
                  rel = os.path.relpath(src, stage_root)
                  dest = os.path.join(repo_root, rel)
                  os.makedirs(os.path.dirname(dest), exist_ok=True)
                  shutil.copyfile(src, dest)

          shutil.rmtree(stage_root)
          PY
      - name: Commit gfx WebP
        if: steps.gfx_stage.outputs.created != '0'
        run: |
          if git status --porcelain | grep -q .; then
            git config user.name "HHG2CBN Update Bot"
            git config user.email "hhg2cbn@users.noreply.github.com"
            git add -- ':(glob)data/**/gfx/**/*.webp'
            git commit -m "Add gfx webp files"
            git push origin HEAD:main
          else
            echo "No gfx changes to commit."
          fi
