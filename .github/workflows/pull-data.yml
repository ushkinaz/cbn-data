name: Pull and Process Cataclysm-BN Data

on:
  schedule:
    - cron: '40 */12 * * *'
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to push data to'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - dev

jobs:
  pull-and-process:
    name: Pull Data, Convert GFX, & Precompress
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout action branch
        uses: actions/checkout@v4
        with:
          ref: action
          fetch-depth: 1
      
      - name: Checkout data branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || 'main' }}
          fetch-depth: 1
          path: data_workspace

      - uses: actions/setup-node@v3
        with:
          node-version: '24.x'
          cache: 'yarn'

      - run: yarn install --frozen-lockfile --ignore-engines

      - name: Pull game data
        uses: actions/github-script@v8
        env:
          DATA_BRANCH: ${{ inputs.target_branch || 'main' }}
          WORKSPACE_DIR: data_workspace
        with:
          script: |
            const { default: run } = await import('${{ github.workspace }}/pull-data.mjs')
            await run({ github, context })

      - name: Install compression tools
        run: sudo apt-get update && sudo apt-get install -y webp brotli

      - name: Convert PNGs to WebP
        working-directory: data_workspace
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Starting GFX PNG to WebP conversion"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          total_converted=0
          total_failed=0
          
          # Iterate over data/DATE directories
          for build_dir in data/*/; do
            if [ ! -d "$build_dir" ]; then continue; fi
            build_name=$(basename "$build_dir")
            
            # Skip special directories
            if [[ "$build_name" == "latest"* ]]; then continue; fi
            
            # Check if gfx directory exists
            if [ ! -d "${build_dir}gfx" ]; then continue; fi
            
            echo "ğŸ“¦ Processing $build_name build"
            build_converted=0
            build_failed=0
            
            # Iterate over data/DATE/gfx/TILESET directories
            for tileset_dir in "${build_dir}gfx"/*/; do
              if [ ! -d "$tileset_dir" ]; then continue; fi
              tileset_name=$(basename "$tileset_dir")
              
              # Find all PNG files using mapfile for safer handling of spaces
              mapfile -t png_files < <(find "$tileset_dir" -type f -name "*.png")
              png_count=${#png_files[@]}
              
              if [ "$png_count" -gt 0 ]; then
                echo "  ğŸ¨ Processing $tileset_name ($png_count PNGs)"
                
                # Convert each PNG to WebP
                for png_file in "${png_files[@]}"; do
                  webp_file="${png_file%.png}.webp"
                  
                  # Convert PNG to WebP with quality 80
                  if cwebp -preset icon "$png_file" -o "$webp_file" >/dev/null 2>&1; then
                    # Delete the original PNG after successful conversion
                    rm "$png_file"
                    build_converted=$((build_converted + 1))
                  else
                    echo "    âš ï¸  Failed to convert: $(basename "$png_file")"
                    build_failed=$((build_failed + 1))
                  fi
                done
              fi
            done
            
            if [ "$build_converted" -gt 0 ]; then
              echo "  âœ… Converted $build_converted files from $build_name"
              if [ "$build_failed" -gt 0 ]; then
                echo "  âš ï¸  Failed: $build_failed files"
              fi
              total_converted=$((total_converted + build_converted))
              total_failed=$((total_failed + build_failed))
            else
              echo "  âœ… No PNGs to convert in $build_name"
            fi
            echo ""
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary: Converted $total_converted files"
          if [ "$total_failed" -gt 0 ]; then
            echo "âš ï¸  Failed: $total_failed files"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Precompress JSON files (Cloudflare-compatible)
        working-directory: data_workspace
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ—œï¸  Precompressing JSON files (Brotli â†’ JSON)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          total_json_count=0
          total_compressed_count=0
          
          # Iterate over build directories
          for build_dir in data/*/; do
            if [ ! -d "$build_dir" ]; then continue; fi
            build_name=$(basename "$build_dir")
            
            # Skip special directories
            if [[ "$build_name" == "latest"* ]]; then continue; fi
            
            # Check for compression marker
            if [ -f "${build_dir}.compressed" ]; then
              echo "  âœ… $build_name is already compressed, skipping"
              continue
            fi
            
            echo "ğŸ“¦ Compressing $build_name build..."
            build_json_count=0
            build_compressed_count=0
            
            # Find all JSON files in this build directory
            while IFS= read -r -d '' json_file; do
              ((build_json_count+=1))
              ((total_json_count+=1))
              
              # Brotli compression (quality 11 = maximum)
              if brotli --best -k -f "$json_file" 2>/dev/null; then
                if [ -f "${json_file}.br" ]; then
                  mv -f "${json_file}.br" "$json_file"
                  ((build_compressed_count+=1))
                  ((total_compressed_count+=1))
                fi
              fi
            done < <(find "$build_dir" -type f -name "*.json" -print0)
            
            if [ "$build_compressed_count" -gt 0 ]; then
              # Create compression marker
              touch "${build_dir}.compressed"
              echo "  âœ¨ Compressed $build_compressed_count files and marked as complete"
            else
              echo "  âš ï¸  No JSON files found in $build_name"
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Compression Summary:"
          echo "  ğŸ“„ Total JSON files found: ${total_json_count}"
          echo "  ğŸ—œï¸  Total Brotli compressed: ${total_compressed_count}"
          echo "  â„¹ï¸  Files are now Brotli-compressed .json"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Commit and push all changes
        working-directory: data_workspace
        run: |
          # Check if there are any changes
          if [[ -n $(git status --porcelain) ]]; then
            echo ""
            echo "ğŸ’¾ Committing all changes..."
            git config user.name "HHG2CBN Update Bot"
            git config user.email "hhg2cbn@users.noreply.github.com"
            git add -A
            
            # Create commit message
            COMMIT_MSG="Update data, convert GFX, and precompress JSON"
            if [ -f builds.json ]; then
              LATEST_BUILD=$(jq -r '.[0].build_number' builds.json || echo "null")
              if [ "$LATEST_BUILD" != "null" ]; then
                COMMIT_MSG="Update data for $LATEST_BUILD"
              fi
            fi
            
            git commit -m "$COMMIT_MSG"
            git push origin HEAD:${{ inputs.target_branch || 'main' }}
            echo "âœ… Successfully pushed all changes"
          else
            echo ""
            echo "â„¹ï¸  No changes to commit"
          fi

