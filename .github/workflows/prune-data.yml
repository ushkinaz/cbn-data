name: Prune Old Data

on:
  schedule:
    - cron: '0 2 12 * *' # Run monthly on 12th at 02:00 UTC
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to prune and squash'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - dev
      backup_branch:
        description: 'Branch name for backup before squashing'
        required: false
        default: 'backup'
        type: string

jobs:
  prune-data:
    name: Prune Old Data
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [24]
    permissions:
      contents: write
    steps:
      - name: Checkout action branch
        uses: actions/checkout@v6
        with:
          ref: action
          fetch-depth: 1
      
      - name: Checkout data branch
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.target_branch || 'main' }}
          fetch-depth: 0  # Full history needed for squashing
          path: data_workspace

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Fetch Dependencies
        run: pnpm install

      - name: Apply retention policy
        uses: actions/github-script@v8
        env:
          DATA_BRANCH: ${{ inputs.target_branch || 'main' }}
          WORKSPACE_DIR: data_workspace
        with:
          script: |
            const { default: run } = await import('${{ github.workspace }}/prune-data.mjs')
            await run()

      - name: Commit pruned data
        working-directory: data_workspace
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "üíæ Committing pruned data..."
            git config user.name "HHG2CBN Update Bot"
            git config user.email "hhg2cbn@users.noreply.github.com"
            git add -A
            git commit -m "Prune data, keeping $(jq 'length' builds.json) builds"
            echo "‚úÖ Pruned data committed"
          else
            echo "‚ÑπÔ∏è  No builds to prune"
          fi

      - name: Create/update backup branch
        working-directory: data_workspace
        run: |
          echo "üì¶ Creating backup branch: ${{ inputs.backup_branch || 'backup' }}"
          git push origin HEAD:refs/heads/${{ inputs.backup_branch || 'backup' }} --force
          echo "‚úÖ Backup branch updated"

      - name: Squash all commits
        working-directory: data_workspace
        run: |
          echo "üîÑ Squashing all commits into one..."
          TREE_SHA=$(git rev-parse HEAD^{tree})
          COMMIT_SHA=$(git commit-tree $TREE_SHA -m "Squashed history - data as of $(date -u +%Y-%m-%d)")
          git reset --hard $COMMIT_SHA
          echo "‚úÖ Created squashed commit: $COMMIT_SHA"
          echo "üìä Repository now has 1 commit"

      - name: Push squashed branch
        working-directory: data_workspace
        run: |
          echo "üöÄ Force pushing squashed branch to ${{ inputs.target_branch || 'main' }}..."
          git push origin HEAD:refs/heads/${{ inputs.target_branch || 'main' }} --force
          echo "‚úÖ Successfully pushed squashed branch"

